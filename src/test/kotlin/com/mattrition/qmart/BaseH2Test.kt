package com.mattrition.qmart

import com.mattrition.qmart.auth.JwtService
import com.mattrition.qmart.config.SecurityConfig
import com.mattrition.qmart.user.User
import com.mattrition.qmart.user.UserRepository
import com.mattrition.qmart.user.UserRole
import org.junit.jupiter.api.BeforeAll
import org.junit.jupiter.api.TestInstance
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.boot.test.context.SpringBootTest
import org.springframework.boot.webmvc.test.autoconfigure.AutoConfigureMockMvc
import org.springframework.context.annotation.Import
import org.springframework.http.HttpHeaders
import org.springframework.http.HttpMethod
import org.springframework.http.MediaType
import org.springframework.security.crypto.password.PasswordEncoder
import org.springframework.test.context.ActiveProfiles
import org.springframework.test.web.servlet.MockMvc
import org.springframework.test.web.servlet.ResultActions
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders
import org.springframework.transaction.annotation.Transactional
import tools.jackson.databind.ObjectMapper

@SpringBootTest
@AutoConfigureMockMvc
@ActiveProfiles("test")
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
@Transactional
@Import(SecurityConfig::class)
abstract class BaseH2Test {
    @Autowired protected lateinit var objectMapper: ObjectMapper

    @Autowired protected lateinit var passwordEncoder: PasswordEncoder

    @Autowired protected lateinit var userRepository: UserRepository

    @Autowired protected lateinit var jwtService: JwtService

    @Autowired protected lateinit var mockMvc: MockMvc

    protected object TestUsers {
        lateinit var user: User
        lateinit var moderator: User
        lateinit var admin: User
        lateinit var superadmin: User
    }

    protected object TestTokens {
        lateinit var user: String
        lateinit var moderator: String
        lateinit var admin: String
        lateinit var superadmin: String
    }

    @BeforeAll
    fun seedUsers() {
        val json = javaClass.getResourceAsStream("/data/users.json")
        val users = objectMapper.readValue(json, Array<TestUserSeed>::class.java)

        userRepository.deleteAll()

        users.forEach { seed ->
            val newUser =
                userRepository.save(
                    User(
                        username = seed.username,
                        passwordHash =
                            passwordEncoder.encode(seed.password)
                                ?: throw RuntimeException(
                                    "Cannot encode password: ${seed.password}",
                                ),
                        email = seed.email,
                        role = seed.role,
                    ),
                )

            val token = jwtService.generateToken(seed.username, newUser.id!!, newUser.role)

            when (seed.role.uppercase()) {
                UserRole.SUPERADMIN -> {
                    TestUsers.superadmin = newUser
                    TestTokens.superadmin = token
                }
                UserRole.ADMIN -> {
                    TestUsers.admin = newUser
                    TestTokens.admin = token
                }
                UserRole.MODERATOR -> {
                    TestUsers.moderator = newUser
                    TestTokens.moderator = token
                }
                else -> {
                    TestUsers.user = newUser
                    TestTokens.user = token
                }
            }
        }
    }

    protected fun mockRequest(
        requestType: HttpMethod,
        path: String,
        token: String? = null,
        body: Any? = null,
    ): ResultActions {
        val builder =
            when (requestType) {
                HttpMethod.GET -> MockMvcRequestBuilders.get(path)
                HttpMethod.POST -> MockMvcRequestBuilders.post(path)
                HttpMethod.PUT -> MockMvcRequestBuilders.put(path)
                HttpMethod.DELETE -> MockMvcRequestBuilders.delete(path)
                HttpMethod.OPTIONS -> MockMvcRequestBuilders.options(path)
                HttpMethod.HEAD -> MockMvcRequestBuilders.head(path)
                HttpMethod.PATCH -> MockMvcRequestBuilders.patch(path)
                else -> throw RuntimeException("Unhandled request: $requestType")
            }

        if (body != null) {
            builder
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(body))
        }

        if (token != null) {
            builder.header(HttpHeaders.AUTHORIZATION, "Bearer $token")
        }

        return mockMvc.perform(builder)
    }
}
